# å­—ä¸²çš„æ“´å……å¥—ä»¶

æœ¬ç« ä»‹ç´¹ ES6 å°å­—ä¸²çš„æ”¹é€ å’Œå¢å¼·ï¼Œä¸‹ä¸€ç« ä»‹ç´¹å­—ä¸²ç‰©ä»¶çš„æ–°å¢æ–¹æ³•ã€‚

## å­—å…ƒçš„ Unicode è¡¨ç¤ºæ³•

ES6 åŠ å¼·äº†å° Unicode çš„æ”¯æ´ï¼Œå…è¨±æ¡ç”¨`\uxxxx`å½¢å¼è¡¨ç¤ºä¸€å€‹å­—å…ƒï¼Œå…¶ä¸­`xxxx`è¡¨ç¤ºå­—å…ƒçš„ Unicode ç¢¼é»ã€‚

```javascript
"\u0061"
// "a"
```

ä½†æ˜¯ï¼Œé€™ç¨®è¡¨ç¤ºæ³•åªé™æ–¼ç¢¼é»åœ¨`\u0000`~`\uFFFF`ä¹‹é–“çš„å­—å…ƒã€‚è¶…å‡ºé€™å€‹ç¯„åœçš„å­—å…ƒï¼Œå¿…é ˆç”¨å…©å€‹é›™ä½å…ƒçµ„çš„å½¢å¼è¡¨ç¤ºã€‚

```javascript
"\uD842\uDFB7"
// "ğ ®·"

"\u20BB7"
// " 7"
```

ä¸Šé¢ç¨‹å¼ç¢¼è¡¨ç¤ºï¼Œå¦‚æœç›´æ¥åœ¨`\u`å¾Œé¢è·Ÿä¸Šè¶…é`0xFFFF`çš„æ•¸å€¼ï¼ˆæ¯”å¦‚`\u20BB7`ï¼‰ï¼ŒJavaScript æœƒç†è§£æˆ`\u20BB+7`ã€‚ç”±æ–¼`\u20BB`æ˜¯ä¸€å€‹ä¸å¯åˆ—å°å­—å…ƒï¼Œæ‰€ä»¥åªæœƒé¡¯ç¤ºä¸€å€‹ç©ºæ ¼ï¼Œå¾Œé¢è·Ÿè‘—ä¸€å€‹`7`ã€‚

ES6 å°é€™ä¸€é»åšå‡ºäº†æ”¹é€²ï¼Œåªè¦å°‡ç¢¼é»æ”¾å…¥å¤§æ‹¬è™Ÿï¼Œå°±èƒ½æ­£ç¢ºè§£è®€è©²å­—å…ƒã€‚

```javascript
"\u{20BB7}"
// "ğ ®·"

"\u{41}\u{42}\u{43}"
// "ABC"

let hello = 123;
hell\u{6F} // 123

'\u{1F680}' === '\uD83D\uDE80'
// true
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­ï¼Œæœ€å¾Œä¸€å€‹ä¾‹å­è¡¨æ˜ï¼Œå¤§æ‹¬è™Ÿè¡¨ç¤ºæ³•èˆ‡å››ä½å…ƒçµ„çš„ UTF-16 ç·¨ç¢¼æ˜¯ç­‰åƒ¹çš„ã€‚

æœ‰äº†é€™ç¨®è¡¨ç¤ºæ³•ä¹‹å¾Œï¼ŒJavaScript å…±æœ‰ 6 ç¨®æ–¹æ³•å¯ä»¥è¡¨ç¤ºä¸€å€‹å­—å…ƒã€‚

```javascript
'\z' === 'z'  // true
'\172' === 'z' // true
'\x7A' === 'z' // true
'\u007A' === 'z' // true
'\u{7A}' === 'z' // true
```

## å­—ä¸²çš„éæ­·å™¨ä»‹é¢

ES6 ç‚ºå­—ä¸²æ·»åŠ äº†éæ­·å™¨ä»‹é¢ï¼ˆè©³è¦‹ã€ŠIteratorã€‹ä¸€ç« ï¼‰ï¼Œä½¿å¾—å­—ä¸²å¯ä»¥è¢«`for...of`è¿´åœˆéæ­·ã€‚

```javascript
for (let codePoint of 'foo') {
  console.log(codePoint)
}
// "f"
// "o"
// "o"
```

é™¤äº†éæ­·å­—ä¸²ï¼Œé€™å€‹éæ­·å™¨æœ€å¤§çš„å„ªé»æ˜¯å¯ä»¥è­˜åˆ¥å¤§æ–¼`0xFFFF`çš„ç¢¼é»ï¼Œå‚³çµ±çš„`for`è¿´åœˆç„¡æ³•è­˜åˆ¥é€™æ¨£çš„ç¢¼é»ã€‚

```javascript
let text = String.fromCodePoint(0x20BB7);

for (let i = 0; i < text.length; i++) {
  console.log(text[i]);
}
// " "
// " "

for (let i of text) {
  console.log(i);
}
// "ğ ®·"
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­ï¼Œå­—ä¸²`text`åªæœ‰ä¸€å€‹å­—å…ƒï¼Œä½†æ˜¯`for`è¿´åœˆæœƒèªç‚ºå®ƒåŒ…å«å…©å€‹å­—å…ƒï¼ˆéƒ½ä¸å¯åˆ—å°ï¼‰ï¼Œè€Œ`for...of`è¿´åœˆæœƒæ­£ç¢ºè­˜åˆ¥å‡ºé€™ä¸€å€‹å­—å…ƒã€‚

## ç›´æ¥è¼¸å…¥ U+2028 å’Œ U+2029

JavaScript å­—ä¸²å…è¨±ç›´æ¥è¼¸å…¥å­—å…ƒï¼Œä»¥åŠè¼¸å…¥å­—å…ƒçš„è½‰ç¾©å½¢å¼ã€‚èˆ‰ä¾‹ä¾†èªªï¼Œâ€œä¸­â€çš„ Unicode ç¢¼é»æ˜¯ U+4e2dï¼Œä½ å¯ä»¥ç›´æ¥åœ¨å­—ä¸²è£¡é¢è¼¸å…¥é€™å€‹æ¼¢å­—ï¼Œä¹Ÿå¯ä»¥è¼¸å…¥å®ƒçš„è½‰ç¾©å½¢å¼`\u4e2d`ï¼Œå…©è€…æ˜¯ç­‰åƒ¹çš„ã€‚

```javascript
'ä¸­' === '\u4e2d' // true
```

ä½†æ˜¯ï¼ŒJavaScript è¦å®šæœ‰5å€‹å­—å…ƒï¼Œä¸èƒ½åœ¨å­—ä¸²è£¡é¢ç›´æ¥ä½¿ç”¨ï¼Œåªèƒ½ä½¿ç”¨è½‰ç¾©å½¢å¼ã€‚

- U+005Cï¼šåæ–œæ§“ï¼ˆreverse solidus)
- U+000Dï¼šå›è»Šï¼ˆcarriage returnï¼‰
- U+2028ï¼šè¡Œåˆ†éš”ç¬¦ï¼ˆline separatorï¼‰
- U+2029ï¼šæ®µåˆ†éš”ç¬¦ï¼ˆparagraph separatorï¼‰
- U+000Aï¼šæ›è¡Œç¬¦ï¼ˆline feedï¼‰

èˆ‰ä¾‹ä¾†èªªï¼Œå­—ä¸²è£¡é¢ä¸èƒ½ç›´æ¥åŒ…å«åæ–œæ§“ï¼Œä¸€å®šè¦è½‰ç¾©å¯«æˆ`\\`æˆ–è€…`\u005c`ã€‚

é€™å€‹è¦å®šæœ¬èº«æ²’æœ‰å•é¡Œï¼Œéº»ç…©åœ¨æ–¼ JSON æ ¼å¼å…è¨±å­—ä¸²è£¡é¢ç›´æ¥ä½¿ç”¨ U+2028ï¼ˆè¡Œåˆ†éš”ç¬¦ï¼‰å’Œ U+2029ï¼ˆæ®µåˆ†éš”ç¬¦ï¼‰ã€‚é€™æ¨£ä¸€ä¾†ï¼Œä¼ºæœå™¨è¼¸å‡ºçš„ JSON è¢«`JSON.parse`è§£æï¼Œå°±æœ‰å¯èƒ½ç›´æ¥å ±éŒ¯ã€‚

```javascript
const json = '"\u2028"';
JSON.parse(json); // å¯èƒ½å ±éŒ¯
```

JSON æ ¼å¼å·²ç¶“å‡çµï¼ˆRFC 7159ï¼‰ï¼Œæ²’æ³•ä¿®æ”¹äº†ã€‚ç‚ºäº†æ¶ˆé™¤é€™å€‹å ±éŒ¯ï¼Œ[ES2019](https://github.com/tc39/proposal-json-superset) å…è¨± JavaScript å­—ä¸²ç›´æ¥è¼¸å…¥ U+2028ï¼ˆè¡Œåˆ†éš”ç¬¦ï¼‰å’Œ U+2029ï¼ˆæ®µåˆ†éš”ç¬¦ï¼‰ã€‚

```javascript
const PS = eval("'\u2029'");
```

æ ¹æ“šé€™å€‹ææ¡ˆï¼Œä¸Šé¢çš„ç¨‹å¼ç¢¼ä¸æœƒå ±éŒ¯ã€‚

æ³¨æ„ï¼Œæ¨¡æ¿å­—ä¸²ç¾åœ¨å°±å…è¨±ç›´æ¥è¼¸å…¥é€™å…©å€‹å­—å…ƒã€‚å¦å¤–ï¼Œæ­£å‰‡è¡¨ç¤ºå¼ä¾ç„¶ä¸å…è¨±ç›´æ¥è¼¸å…¥é€™å…©å€‹å­—å…ƒï¼Œé€™æ˜¯æ²’æœ‰å•é¡Œçš„ï¼Œå› ç‚º JSON æœ¬ä¾†å°±ä¸å…è¨±ç›´æ¥åŒ…å«æ­£å‰‡è¡¨ç¤ºå¼ã€‚

## JSON.stringify() çš„æ”¹é€ 

æ ¹æ“šæ¨™æº–ï¼ŒJSON è³‡æ–™å¿…é ˆæ˜¯ UTF-8 ç·¨ç¢¼ã€‚ä½†æ˜¯ï¼Œç¾åœ¨çš„`JSON.stringify()`æ–¹æ³•æœ‰å¯èƒ½è¿”å›ä¸ç¬¦åˆ UTF-8 æ¨™æº–çš„å­—ä¸²ã€‚

å…·é«”ä¾†èªªï¼ŒUTF-8 æ¨™æº–è¦å®šï¼Œ`0xD800`åˆ°`0xDFFF`ä¹‹é–“çš„ç¢¼é»ï¼Œä¸èƒ½å–®ç¨ä½¿ç”¨ï¼Œå¿…é ˆé…å°ä½¿ç”¨ã€‚æ¯”å¦‚ï¼Œ`\uD834\uDF06`æ˜¯å…©å€‹ç¢¼é»ï¼Œä½†æ˜¯å¿…é ˆæ”¾åœ¨ä¸€èµ·é…å°ä½¿ç”¨ï¼Œä»£è¡¨å­—å…ƒ`ğŒ†`ã€‚é€™æ˜¯ç‚ºäº†è¡¨ç¤ºç¢¼é»å¤§æ–¼`0xFFFF`çš„å­—å…ƒçš„ä¸€ç¨®è®Šé€šæ–¹æ³•ã€‚å–®ç¨ä½¿ç”¨`\uD834`å’Œ`\uDFO6`é€™å…©å€‹ç¢¼é»æ˜¯ä¸åˆæ³•çš„ï¼Œæˆ–è€…é¡›å€’é †åºä¹Ÿä¸è¡Œï¼Œå› ç‚º`\uDF06\uD834`ä¸¦æ²’æœ‰å°æ‡‰çš„å­—å…ƒã€‚

`JSON.stringify()`çš„å•é¡Œåœ¨æ–¼ï¼Œå®ƒå¯èƒ½è¿”å›`0xD800`åˆ°`0xDFFF`ä¹‹é–“çš„å–®å€‹ç¢¼é»ã€‚

```javascript
JSON.stringify('\u{D834}') // "\u{D834}"
```

ç‚ºäº†ç¢ºä¿è¿”å›çš„æ˜¯åˆæ³•çš„ UTF-8 å­—å…ƒï¼Œ[ES2019](https://github.com/tc39/proposal-well-formed-stringify) æ”¹è®Šäº†`JSON.stringify()`çš„è¡Œç‚ºã€‚å¦‚æœé‡åˆ°`0xD800`åˆ°`0xDFFF`ä¹‹é–“çš„å–®å€‹ç¢¼é»ï¼Œæˆ–è€…ä¸å­˜åœ¨çš„é…å°å½¢å¼ï¼Œå®ƒæœƒè¿”å›è·³è„«å­—å…ƒä¸²ï¼Œç•™çµ¦æ‡‰ç”¨è‡ªå·±æ±ºå®šä¸‹ä¸€æ­¥çš„è™•ç†ã€‚

```javascript
JSON.stringify('\u{D834}') // ""\\uD834""
JSON.stringify('\uDF06\uD834') // ""\\udf06\\ud834""
```

## æ¨¡æ¿å­—ä¸²

å‚³çµ±çš„ JavaScript èªè¨€ï¼Œè¼¸å‡ºæ¨¡æ¿é€šå¸¸æ˜¯é€™æ¨£å¯«çš„ï¼ˆä¸‹é¢ä½¿ç”¨äº† jQuery çš„æ–¹æ³•ï¼‰ã€‚

```javascript
$('#result').append(
  'There are <b>' + basket.count + '</b> ' +
  'items in your basket, ' +
  '<em>' + basket.onSale +
  '</em> are on sale!'
);
```

ä¸Šé¢é€™ç¨®å¯«æ³•ç›¸ç•¶ç¹ç‘£ä¸æ–¹ä¾¿ï¼ŒES6 å¼•å…¥äº†æ¨¡æ¿å­—ä¸²è§£æ±ºé€™å€‹å•é¡Œã€‚

```javascript
$('#result').append(`
  There are <b>${basket.count}</b> items
   in your basket, <em>${basket.onSale}</em>
  are on sale!
`);
```

æ¨¡æ¿å­—ä¸²ï¼ˆtemplate stringï¼‰æ˜¯å¢å¼·ç‰ˆçš„å­—ä¸²ï¼Œç”¨åå¼•è™Ÿï¼ˆ&#96;ï¼‰æ¨™è­˜ã€‚å®ƒå¯ä»¥ç•¶ä½œæ™®é€šå­—ä¸²ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç”¨ä¾†å®šç¾©å¤šè¡Œå­—ä¸²ï¼Œæˆ–è€…åœ¨å­—ä¸²ä¸­åµŒå…¥è®Šæ•¸ã€‚

```javascript
// æ™®é€šå­—ä¸²
`In JavaScript '\n' is a line-feed.`

// å¤šè¡Œå­—ä¸²
`In JavaScript this is
 not legal.`

console.log(`string text line 1
string text line 2`);

// å­—ä¸²ä¸­åµŒå…¥è®Šæ•¸
let name = "Bob", time = "today";
`Hello ${name}, how are you ${time}?`
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­çš„æ¨¡æ¿å­—ä¸²ï¼Œéƒ½æ˜¯ç”¨åå¼•è™Ÿè¡¨ç¤ºã€‚å¦‚æœåœ¨æ¨¡æ¿å­—ä¸²ä¸­éœ€è¦ä½¿ç”¨åå¼•è™Ÿï¼Œå‰‡å‰é¢è¦ç”¨åæ–œæ§“è½‰ç¾©ã€‚

```javascript
let greeting = `\`Yo\` World!`;
```

å¦‚æœä½¿ç”¨æ¨¡æ¿å­—ä¸²è¡¨ç¤ºå¤šè¡Œå­—ä¸²ï¼Œæ‰€æœ‰çš„ç©ºæ ¼å’Œç¸®æ’éƒ½æœƒè¢«ä¿ç•™åœ¨è¼¸å‡ºä¹‹ä¸­ã€‚

```javascript
$('#list').html(`
<ul>
  <li>first</li>
  <li>second</li>
</ul>
`);
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­ï¼Œæ‰€æœ‰æ¨¡æ¿å­—ä¸²çš„ç©ºæ ¼å’Œæ›è¡Œï¼Œéƒ½æ˜¯è¢«ä¿ç•™çš„ï¼Œæ¯”å¦‚`<ul>`æ¨™ç±¤å‰é¢æœƒæœ‰ä¸€å€‹æ›è¡Œã€‚å¦‚æœä½ ä¸æƒ³è¦é€™å€‹æ›è¡Œï¼Œå¯ä»¥ä½¿ç”¨`trim`æ–¹æ³•æ¶ˆé™¤å®ƒã€‚

```javascript
$('#list').html(`
<ul>
  <li>first</li>
  <li>second</li>
</ul>
`.trim());
```

æ¨¡æ¿å­—ä¸²ä¸­åµŒå…¥è®Šæ•¸ï¼Œéœ€è¦å°‡è®Šæ•¸åå¯«åœ¨`${}`ä¹‹ä¸­ã€‚

```javascript
function authorize(user, action) {
  if (!user.hasPrivilege(action)) {
    throw new Error(
      // å‚³çµ±å¯«æ³•ç‚º
      // 'User '
      // + user.name
      // + ' is not authorized to do '
      // + action
      // + '.'
      `User ${user.name} is not authorized to do ${action}.`);
  }
}
```

å¤§æ‹¬è™Ÿå…§éƒ¨å¯ä»¥æ”¾å…¥ä»»æ„çš„ JavaScript è¡¨ç¤ºå¼ï¼Œå¯ä»¥é€²è¡Œé‹ç®—ï¼Œä»¥åŠå¼•ç”¨ç‰©ä»¶å±¬æ€§ã€‚

```javascript
let x = 1;
let y = 2;

`${x} + ${y} = ${x + y}`
// "1 + 2 = 3"

`${x} + ${y * 2} = ${x + y * 2}`
// "1 + 4 = 5"

let obj = {x: 1, y: 2};
`${obj.x + obj.y}`
// "3"
```

æ¨¡æ¿å­—ä¸²ä¹‹ä¸­é‚„èƒ½å‘¼å«å‡½å¼ã€‚

```javascript
function fn() {
  return "Hello World";
}

`foo ${fn()} bar`
// foo Hello World bar
```

å¦‚æœå¤§æ‹¬è™Ÿä¸­çš„å€¼ä¸æ˜¯å­—ä¸²ï¼Œå°‡æŒ‰ç…§ä¸€èˆ¬çš„è¦å‰‡è½‰ç‚ºå­—ä¸²ã€‚æ¯”å¦‚ï¼Œå¤§æ‹¬è™Ÿä¸­æ˜¯ä¸€å€‹ç‰©ä»¶ï¼Œå°‡é è¨­å‘¼å«ç‰©ä»¶çš„`toString`æ–¹æ³•ã€‚

å¦‚æœæ¨¡æ¿å­—ä¸²ä¸­çš„è®Šæ•¸æ²’æœ‰å®£å‘Šï¼Œå°‡å ±éŒ¯ã€‚

```javascript
// è®Šæ•¸placeæ²’æœ‰å®£å‘Š
let msg = `Hello, ${place}`;
// å ±éŒ¯
```

ç”±æ–¼æ¨¡æ¿å­—ä¸²çš„å¤§æ‹¬è™Ÿå…§éƒ¨ï¼Œå°±æ˜¯åŸ·è¡Œ JavaScript ç¨‹å¼ç¢¼ï¼Œå› æ­¤å¦‚æœå¤§æ‹¬è™Ÿå…§éƒ¨æ˜¯ä¸€å€‹å­—ä¸²ï¼Œå°‡æœƒåŸæ¨£è¼¸å‡ºã€‚

```javascript
`Hello ${'World'}`
// "Hello World"
```

æ¨¡æ¿å­—ä¸²ç”šè‡³é‚„èƒ½å·¢ç‹€ã€‚

```javascript
const tmpl = addrs => `
  <table>
  ${addrs.map(addr => `
    <tr><td>${addr.first}</td></tr>
    <tr><td>${addr.last}</td></tr>
  `).join('')}
  </table>
`;
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­ï¼Œæ¨¡æ¿å­—ä¸²çš„è®Šæ•¸ä¹‹ä¸­ï¼ŒåˆåµŒå…¥äº†å¦ä¸€å€‹æ¨¡æ¿å­—ä¸²ï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ã€‚

```javascript
const data = [
    { first: '<Jane>', last: 'Bond' },
    { first: 'Lars', last: '<Croft>' },
];

console.log(tmpl(data));
// <table>
//
//   <tr><td><Jane></td></tr>
//   <tr><td>Bond</td></tr>
//
//   <tr><td>Lars</td></tr>
//   <tr><td><Croft></td></tr>
//
// </table>
```

å¦‚æœéœ€è¦å¼•ç”¨æ¨¡æ¿å­—ä¸²æœ¬èº«ï¼Œåœ¨éœ€è¦æ™‚åŸ·è¡Œï¼Œå¯ä»¥å¯«æˆå‡½å¼ã€‚

```javascript
let func = (name) => `Hello ${name}!`;
func('Jack') // "Hello Jack!"
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­ï¼Œæ¨¡æ¿å­—ä¸²å¯«æˆäº†ä¸€å€‹å‡½å¼çš„è¿”å›å€¼ã€‚åŸ·è¡Œé€™å€‹å‡½å¼ï¼Œå°±ç›¸ç•¶æ–¼åŸ·è¡Œé€™å€‹æ¨¡æ¿å­—ä¸²äº†ã€‚

## ä¾‹é …ï¼šæ¨¡æ¿ç·¨è­¯

ä¸‹é¢ï¼Œæˆ‘å€‘ä¾†çœ‹ä¸€å€‹é€éæ¨¡æ¿å­—ä¸²ï¼Œç”Ÿæˆæ­£å¼æ¨¡æ¿çš„ä¾‹é …ã€‚

```javascript
let template = `
<ul>
  <% for(let i=0; i < data.supplies.length; i++) { %>
    <li><%= data.supplies[i] %></li>
  <% } %>
</ul>
`;
```

ä¸Šé¢ç¨‹å¼ç¢¼åœ¨æ¨¡æ¿å­—ä¸²ä¹‹ä¸­ï¼Œæ”¾ç½®äº†ä¸€å€‹å¸¸è¦æ¨¡æ¿ã€‚è©²æ¨¡æ¿ä½¿ç”¨`<%...%>`æ”¾ç½® JavaScript ç¨‹å¼ç¢¼ï¼Œä½¿ç”¨`<%= ... %>`è¼¸å‡º JavaScript è¡¨ç¤ºå¼ã€‚

æ€éº¼ç·¨è­¯é€™å€‹æ¨¡æ¿å­—ä¸²å‘¢ï¼Ÿ

ä¸€ç¨®æ€è·¯æ˜¯å°‡å…¶è½‰æ›ç‚º JavaScript è¡¨ç¤ºå¼å­—ä¸²ã€‚

```javascript
echo('<ul>');
for(let i=0; i < data.supplies.length; i++) {
  echo('<li>');
  echo(data.supplies[i]);
  echo('</li>');
};
echo('</ul>');
```

é€™å€‹è½‰æ›ä½¿ç”¨æ­£å‰‡è¡¨ç¤ºå¼å°±è¡Œäº†ã€‚

```javascript
let evalExpr = /<%=(.+?)%>/g;
let expr = /<%([\s\S]+?)%>/g;

template = template
  .replace(evalExpr, '`); \n  echo( $1 ); \n  echo(`')
  .replace(expr, '`); \n $1 \n  echo(`');

template = 'echo(`' + template + '`);';
```

ç„¶å¾Œï¼Œå°‡`template`å°è£åœ¨ä¸€å€‹å‡½å¼è£¡é¢è¿”å›ï¼Œå°±å¯ä»¥äº†ã€‚

```javascript
let script =
`(function parse(data){
  let output = "";

  function echo(html){
    output += html;
  }

  ${ template }

  return output;
})`;

return script;
```

å°‡ä¸Šé¢çš„å…§å®¹æ‹¼è£æˆä¸€å€‹æ¨¡æ¿ç·¨è­¯å‡½å¼`compile`ã€‚

```javascript
function compile(template){
  const evalExpr = /<%=(.+?)%>/g;
  const expr = /<%([\s\S]+?)%>/g;

  template = template
    .replace(evalExpr, '`); \n  echo( $1 ); \n  echo(`')
    .replace(expr, '`); \n $1 \n  echo(`');

  template = 'echo(`' + template + '`);';

  let script =
  `(function parse(data){
    let output = "";

    function echo(html){
      output += html;
    }

    ${ template }

    return output;
  })`;

  return script;
}
```

`compile`å‡½å¼çš„ç”¨æ³•å¦‚ä¸‹ã€‚

```javascript
let parse = eval(compile(template));
div.innerHTML = parse({ supplies: [ "broom", "mop", "cleaner" ] });
//   <ul>
//     <li>broom</li>
//     <li>mop</li>
//     <li>cleaner</li>
//   </ul>
```

## æ¨™ç±¤æ¨¡æ¿

æ¨¡æ¿å­—ä¸²çš„åŠŸèƒ½ï¼Œä¸åƒ…åƒ…æ˜¯ä¸Šé¢é€™äº›ã€‚å®ƒå¯ä»¥ç·Šè·Ÿåœ¨ä¸€å€‹å‡½å¼åå¾Œé¢ï¼Œè©²å‡½å¼å°‡è¢«å‘¼å«ä¾†è™•ç†é€™å€‹æ¨¡æ¿å­—ä¸²ã€‚é€™è¢«ç¨±ç‚ºâ€œæ¨™ç±¤æ¨¡æ¿â€åŠŸèƒ½ï¼ˆtagged templateï¼‰ã€‚

```javascript
alert`hello`
// ç­‰åŒæ–¼
alert(['hello'])
```

æ¨™ç±¤æ¨¡æ¿å…¶å¯¦ä¸æ˜¯æ¨¡æ¿ï¼Œè€Œæ˜¯å‡½å¼å‘¼å«çš„ä¸€ç¨®ç‰¹æ®Šå½¢å¼ã€‚â€œæ¨™ç±¤â€æŒ‡çš„å°±æ˜¯å‡½å¼ï¼Œç·Šè·Ÿåœ¨å¾Œé¢çš„æ¨¡æ¿å­—ä¸²å°±æ˜¯å®ƒçš„å¼•æ•¸ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ¨¡æ¿å­—å…ƒè£¡é¢æœ‰è®Šæ•¸ï¼Œå°±ä¸æ˜¯ç°¡å–®çš„å‘¼å«äº†ï¼Œè€Œæ˜¯æœƒå°‡æ¨¡æ¿å­—ä¸²å…ˆè™•ç†æˆå¤šå€‹å¼•æ•¸ï¼Œå†å‘¼å«å‡½å¼ã€‚

```javascript
let a = 5;
let b = 10;

tag`Hello ${ a + b } world ${ a * b }`;
// ç­‰åŒæ–¼
tag(['Hello ', ' world ', ''], 15, 50);
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­ï¼Œæ¨¡æ¿å­—ä¸²å‰é¢æœ‰ä¸€å€‹æ¨™è­˜å`tag`ï¼Œå®ƒæ˜¯ä¸€å€‹å‡½å¼ã€‚æ•´å€‹è¡¨ç¤ºå¼çš„è¿”å›å€¼ï¼Œå°±æ˜¯`tag`å‡½å¼è™•ç†æ¨¡æ¿å­—ä¸²å¾Œçš„è¿”å›å€¼ã€‚

å‡½å¼`tag`ä¾æ¬¡æœƒæ¥æ”¶åˆ°å¤šå€‹å¼•æ•¸ã€‚

```javascript
function tag(stringArr, value1, value2){
  // ...
}

// ç­‰åŒæ–¼

function tag(stringArr, ...values){
  // ...
}
```

`tag`å‡½å¼çš„ç¬¬ä¸€å€‹å¼•æ•¸æ˜¯ä¸€å€‹æ•¸çµ„ï¼Œè©²é™£åˆ—çš„æˆå“¡æ˜¯æ¨¡æ¿å­—ä¸²ä¸­é‚£äº›æ²’æœ‰è®Šæ•¸æ›¿æ›çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯èªªï¼Œè®Šæ•¸æ›¿æ›éš»ç™¼ç”Ÿåœ¨é™£åˆ—çš„ç¬¬ä¸€å€‹æˆå“¡èˆ‡ç¬¬äºŒå€‹æˆå“¡ä¹‹é–“ã€ç¬¬äºŒå€‹æˆå“¡èˆ‡ç¬¬ä¸‰å€‹æˆå“¡ä¹‹é–“ï¼Œä»¥æ­¤é¡æ¨ã€‚

`tag`å‡½å¼çš„å…¶ä»–å¼•æ•¸ï¼Œéƒ½æ˜¯æ¨¡æ¿å­—ä¸²å„å€‹è®Šæ•¸è¢«æ›¿æ›å¾Œçš„å€¼ã€‚ç”±æ–¼æœ¬ä¾‹ä¸­ï¼Œæ¨¡æ¿å­—ä¸²å«æœ‰å…©å€‹è®Šæ•¸ï¼Œå› æ­¤`tag`æœƒæ¥å—åˆ°`value1`å’Œ`value2`å…©å€‹å¼•æ•¸ã€‚

`tag`å‡½å¼æ‰€æœ‰å¼•æ•¸çš„å¯¦éš›å€¼å¦‚ä¸‹ã€‚

- ç¬¬ä¸€å€‹å¼•æ•¸ï¼š`['Hello ', ' world ', '']`
- ç¬¬äºŒå€‹å¼•æ•¸: 15
- ç¬¬ä¸‰å€‹å¼•æ•¸ï¼š50

ä¹Ÿå°±æ˜¯èªªï¼Œ`tag`å‡½å¼å¯¦éš›ä¸Šä»¥ä¸‹é¢çš„å½¢å¼å‘¼å«ã€‚

```javascript
tag(['Hello ', ' world ', ''], 15, 50)
```

æˆ‘å€‘å¯ä»¥æŒ‰ç…§éœ€è¦ç·¨å¯«`tag`å‡½å¼çš„ç¨‹å¼ç¢¼ã€‚ä¸‹é¢æ˜¯`tag`å‡½å¼çš„ä¸€ç¨®å¯«æ³•ï¼Œä»¥åŠåŸ·è¡Œçµæœã€‚

```javascript
let a = 5;
let b = 10;

function tag(s, v1, v2) {
  console.log(s[0]);
  console.log(s[1]);
  console.log(s[2]);
  console.log(v1);
  console.log(v2);

  return "OK";
}

tag`Hello ${ a + b } world ${ a * b}`;
// "Hello "
// " world "
// ""
// 15
// 50
// "OK"
```

ä¸‹é¢æ˜¯ä¸€å€‹æ›´å¾©é›œçš„ä¾‹å­ã€‚

```javascript
let total = 30;
let msg = passthru`The total is ${total} (${total*1.05} with tax)`;

function passthru(literals) {
  let result = '';
  let i = 0;

  while (i < literals.length) {
    result += literals[i++];
    if (i < arguments.length) {
      result += arguments[i];
    }
  }

  return result;
}

msg // "The total is 30 (31.5 with tax)"
```

ä¸Šé¢é€™å€‹ä¾‹å­å±•ç¤ºäº†ï¼Œå¦‚ä½•å°‡å„å€‹å¼•æ•¸æŒ‰ç…§åŸä¾†çš„ä½ç½®æ‹¼åˆå›å»ã€‚

`passthru`å‡½å¼æ¡ç”¨ rest å¼•æ•¸çš„å¯«æ³•å¦‚ä¸‹ã€‚

```javascript
function passthru(literals, ...values) {
  let output = "";
  let index;
  for (index = 0; index < values.length; index++) {
    output += literals[index] + values[index];
  }

  output += literals[index]
  return output;
}
```

â€œæ¨™ç±¤æ¨¡æ¿â€çš„ä¸€å€‹é‡è¦æ‡‰ç”¨ï¼Œå°±æ˜¯éæ¿¾ HTML å­—ä¸²ï¼Œé˜²æ­¢ä½¿ç”¨è€…è¼¸å…¥æƒ¡æ„å…§å®¹ã€‚

```javascript
let message =
  SaferHTML`<p>${sender} has sent you a message.</p>`;

function SaferHTML(templateData) {
  let s = templateData[0];
  for (let i = 1; i < arguments.length; i++) {
    let arg = String(arguments[i]);

    // Escape special characters in the substitution.
    s += arg.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

    // Don't escape special characters in the template.
    s += templateData[i];
  }
  return s;
}
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­ï¼Œ`sender`è®Šæ•¸å¾€å¾€æ˜¯ä½¿ç”¨è€…æä¾›çš„ï¼Œç¶“é`SaferHTML`å‡½å¼è™•ç†ï¼Œè£¡é¢çš„ç‰¹æ®Šå­—å…ƒéƒ½æœƒè¢«è½‰ç¾©ã€‚

```javascript
let sender = '<script>alert("abc")</script>'; // æƒ¡æ„ç¨‹å¼ç¢¼
let message = SaferHTML`<p>${sender} has sent you a message.</p>`;

message
// <p>&lt;script&gt;alert("abc")&lt;/script&gt; has sent you a message.</p>
```

æ¨™ç±¤æ¨¡æ¿çš„å¦ä¸€å€‹æ‡‰ç”¨ï¼Œå°±æ˜¯å¤šèªè¨€è½‰æ›ï¼ˆåœ‹éš›åŒ–è™•ç†ï¼‰ã€‚

```javascript
i18n`Welcome to ${siteName}, you are visitor number ${visitorNumber}!`
// "æ­¡è¿è¨ªå•xxxï¼Œæ‚¨æ˜¯ç¬¬xxxxä½è¨ªå•è€…ï¼"
```

æ¨¡æ¿å­—ä¸²æœ¬èº«ä¸¦ä¸èƒ½å–ä»£ Mustache ä¹‹é¡çš„æ¨¡æ¿åº«ï¼Œå› ç‚ºæ²’æœ‰æ¢ä»¶åˆ¤æ–·å’Œè¿´åœˆè™•ç†åŠŸèƒ½ï¼Œä½†æ˜¯é€éæ¨™ç±¤å‡½å¼ï¼Œä½ å¯ä»¥è‡ªå·±æ–°å¢é€™äº›åŠŸèƒ½ã€‚

```javascript
// ä¸‹é¢çš„hashTemplateå‡½å¼
// æ˜¯ä¸€å€‹è‡ªå®šç¾©çš„æ¨¡æ¿è™•ç†å‡½å¼
let libraryHtml = hashTemplate`
  <ul>
    #for book in ${myBooks}
      <li><i>#{book.title}</i> by #{book.author}</li>
    #end
  </ul>
`;
```

é™¤æ­¤ä¹‹å¤–ï¼Œä½ ç”šè‡³å¯ä»¥ä½¿ç”¨æ¨™ç±¤æ¨¡æ¿ï¼Œåœ¨ JavaScript èªè¨€ä¹‹ä¸­åµŒå…¥å…¶ä»–èªè¨€ã€‚

```javascript
jsx`
  <div>
    <input
      ref='input'
      onChange='${this.handleChange}'
      defaultValue='${this.state.value}' />
      ${this.state.value}
   </div>
`
```

ä¸Šé¢çš„ç¨‹å¼ç¢¼é€é`jsx`å‡½å¼ï¼Œå°‡ä¸€å€‹ DOM å­—ä¸²è½‰ç‚º React ç‰©ä»¶ã€‚ä½ å¯ä»¥åœ¨ GitHub æ‰¾åˆ°`jsx`å‡½å¼çš„[å…·é«”å¯¦ç¾](https://gist.github.com/lygaret/a68220defa69174bdec5)ã€‚

ä¸‹é¢å‰‡æ˜¯ä¸€å€‹å‡æƒ³çš„ä¾‹å­ï¼Œé€é`java`å‡½å¼ï¼Œåœ¨ JavaScript ç¨‹å¼ç¢¼ä¹‹ä¸­åŸ·è¡Œ Java ç¨‹å¼ç¢¼ã€‚

```javascript
java`
class HelloWorldApp {
  public static void main(String[] args) {
    System.out.println("Hello World!"); // Display the string.
  }
}
`
HelloWorldApp.main();
```

æ¨¡æ¿è™•ç†å‡½å¼çš„ç¬¬ä¸€å€‹å¼•æ•¸ï¼ˆæ¨¡æ¿å­—ä¸²é™£åˆ—ï¼‰ï¼Œé‚„æœ‰ä¸€å€‹`raw`å±¬æ€§ã€‚

```javascript
console.log`123`
// ["123", raw: Array[1]]
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­ï¼Œ`console.log`æ¥å—çš„å¼•æ•¸ï¼Œå¯¦éš›ä¸Šæ˜¯ä¸€å€‹æ•¸çµ„ã€‚è©²é™£åˆ—æœ‰ä¸€å€‹`raw`å±¬æ€§ï¼Œå„²å­˜çš„æ˜¯è½‰ç¾©å¾Œçš„åŸå­—ä¸²ã€‚

è«‹çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚

```javascript
tag`First line\nSecond line`

function tag(strings) {
  console.log(strings.raw[0]);
  // strings.raw[0] ç‚º "First line\\nSecond line"
  // åˆ—å°è¼¸å‡º "First line\nSecond line"
}
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­ï¼Œ`tag`å‡½å¼çš„ç¬¬ä¸€å€‹å¼•æ•¸`strings`ï¼Œæœ‰ä¸€å€‹`raw`å±¬æ€§ï¼Œä¹ŸæŒ‡å‘ä¸€å€‹æ•¸çµ„ã€‚è©²é™£åˆ—çš„æˆå“¡èˆ‡`strings`é™£åˆ—å®Œå…¨ä¸€è‡´ã€‚æ¯”å¦‚ï¼Œ`strings`é™£åˆ—æ˜¯`["First line\nSecond line"]`ï¼Œé‚£éº¼`strings.raw`é™£åˆ—å°±æ˜¯`["First line\\nSecond line"]`ã€‚å…©è€…å”¯ä¸€çš„å€åˆ¥ï¼Œå°±æ˜¯å­—ä¸²è£¡é¢çš„æ–œæ§“éƒ½è¢«è½‰ç¾©äº†ã€‚æ¯”å¦‚ï¼Œstrings.raw é™£åˆ—æœƒå°‡`\n`è¦–ç‚º`\\`å’Œ`n`å…©å€‹å­—å…ƒï¼Œè€Œä¸æ˜¯æ›è¡Œç¬¦ã€‚é€™æ˜¯ç‚ºäº†æ–¹ä¾¿å–å¾—è½‰ç¾©ä¹‹å‰çš„åŸå§‹æ¨¡æ¿è€Œè¨­è¨ˆçš„ã€‚

## æ¨¡æ¿å­—ä¸²çš„é™åˆ¶

å‰é¢æåˆ°æ¨™ç±¤æ¨¡æ¿è£¡é¢ï¼Œå¯ä»¥å…§åµŒå…¶ä»–èªè¨€ã€‚ä½†æ˜¯ï¼Œæ¨¡æ¿å­—ä¸²é è¨­æœƒå°‡å­—ä¸²è½‰ç¾©ï¼Œå°è‡´ç„¡æ³•åµŒå…¥å…¶ä»–èªè¨€ã€‚

èˆ‰ä¾‹ä¾†èªªï¼Œæ¨™ç±¤æ¨¡æ¿è£¡é¢å¯ä»¥åµŒå…¥ LaTEX èªè¨€ã€‚

```javascript
function latex(strings) {
  // ...
}

let document = latex`
\newcommand{\fun}{\textbf{Fun!}}  // æ­£å¸¸å·¥ä½œ
\newcommand{\unicode}{\textbf{Unicode!}} // å ±éŒ¯
\newcommand{\xerxes}{\textbf{King!}} // å ±éŒ¯

Breve over the h goes \u{h}ere // å ±éŒ¯
`
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­ï¼Œè®Šæ•¸`document`å…§åµŒçš„æ¨¡æ¿å­—ä¸²ï¼Œå°æ–¼ LaTEX èªè¨€ä¾†èªªå®Œå…¨æ˜¯åˆæ³•çš„ï¼Œä½†æ˜¯ JavaScript å¼•æ“æœƒå ±éŒ¯ã€‚åŸå› å°±åœ¨æ–¼å­—ä¸²çš„è½‰ç¾©ã€‚

æ¨¡æ¿å­—ä¸²æœƒå°‡`\u00FF`å’Œ`\u{42}`ç•¶ä½œ Unicode å­—å…ƒé€²è¡Œè½‰ç¾©ï¼Œæ‰€ä»¥`\unicode`è§£ææ™‚å ±éŒ¯ï¼›è€Œ`\x56`æœƒè¢«ç•¶ä½œåå…­é€²ä½åˆ¶å­—ä¸²è½‰ç¾©ï¼Œæ‰€ä»¥`\xerxes`æœƒå ±éŒ¯ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œ`\u`å’Œ`\x`åœ¨ LaTEX è£¡é¢æœ‰ç‰¹æ®Šå«ç¾©ï¼Œä½†æ˜¯ JavaScript å°‡å®ƒå€‘è½‰ç¾©äº†ã€‚

ç‚ºäº†è§£æ±ºé€™å€‹å•é¡Œï¼ŒES2018 [æ”¾é¬†](https://tc39.github.io/proposal-template-literal-revision/)äº†å°æ¨™ç±¤æ¨¡æ¿è£¡é¢çš„å­—ä¸²è½‰ç¾©çš„é™åˆ¶ã€‚å¦‚æœé‡åˆ°ä¸åˆæ³•çš„å­—ä¸²è½‰ç¾©ï¼Œå°±è¿”å›`undefined`ï¼Œè€Œä¸æ˜¯å ±éŒ¯ï¼Œä¸¦ä¸”å¾`raw`å±¬æ€§ä¸Šé¢å¯ä»¥å¾—åˆ°åŸå§‹å­—ä¸²ã€‚

```javascript
function tag(strs) {
  strs[0] === undefined
  strs.raw[0] === "\\unicode and \\u{55}";
}
tag`\unicode and \u{55}`
```

ä¸Šé¢ç¨‹å¼ç¢¼ä¸­ï¼Œæ¨¡æ¿å­—ä¸²åŸæœ¬æ˜¯æ‡‰è©²å ±éŒ¯çš„ï¼Œä½†æ˜¯ç”±æ–¼æ”¾é¬†äº†å°å­—ä¸²è½‰ç¾©çš„é™åˆ¶ï¼Œæ‰€ä»¥ä¸å ±éŒ¯äº†ï¼ŒJavaScript å¼•æ“å°‡ç¬¬ä¸€å€‹å­—å…ƒè¨­å®šç‚º`undefined`ï¼Œä½†æ˜¯`raw`å±¬æ€§ä¾ç„¶å¯ä»¥å¾—åˆ°åŸå§‹å­—ä¸²ï¼Œå› æ­¤`tag`å‡½å¼é‚„æ˜¯å¯ä»¥å°åŸå­—ä¸²é€²è¡Œè™•ç†ã€‚

æ³¨æ„ï¼Œé€™ç¨®å°å­—ä¸²è½‰ç¾©çš„æ”¾é¬†ï¼Œåªåœ¨æ¨™ç±¤æ¨¡æ¿è§£æå­—ä¸²æ™‚ç”Ÿæ•ˆï¼Œä¸æ˜¯æ¨™ç±¤æ¨¡æ¿çš„å ´åˆï¼Œä¾ç„¶æœƒå ±éŒ¯ã€‚

```javascript
let bad = `bad escape sequence: \unicode`; // å ±éŒ¯
```
